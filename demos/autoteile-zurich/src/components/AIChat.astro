---
// Interactive AI Chat Widget for Demo (with predefined responses)
interface Props {
  businessType?: 'auto-parts' | 'bakery' | 'lawyer' | 'restaurant' | 'default';
  companyName?: string;
  phone?: string;
  mapsUrl?: string;
}

const { businessType = 'default', companyName = 'Unser Team', phone, mapsUrl } = Astro.props;
---

<div id="ai-chat-widget" class="fixed bottom-4 right-4 md:bottom-6 md:right-6 z-50">
  <button
    id="chat-toggle"
    class="bg-blue-600 text-white p-3 md:p-4 rounded-full shadow-lg hover:bg-blue-700 transition-all hover:scale-110"
  >
    ğŸ’¬
  </button>

  <div
    id="chat-window"
    class="hidden fixed md:absolute bottom-0 left-0 right-0 md:bottom-16 md:right-0 md:left-auto w-full md:w-96 bg-white md:rounded-lg shadow-2xl border-t md:border border-gray-200 flex flex-col"
    style="max-height: 85vh; height: 85vh;"
  >
    <div class="bg-blue-600 text-white p-3 md:p-4 flex items-center justify-between flex-shrink-0">
      <h3 class="font-semibold text-base md:text-lg">Chat Assistent</h3>
      <button id="chat-close" class="text-white hover:text-gray-200 text-2xl md:text-xl p-1">âœ•</button>
    </div>

    <div id="chat-messages" class="flex-1 overflow-y-auto p-3 md:p-4 space-y-3 bg-gray-50">
      <!-- Messages will be inserted here -->
    </div>

    <div id="chat-input-area" class="p-3 md:p-4 border-t border-gray-200 bg-white flex-shrink-0 max-h-[40vh] overflow-y-auto">
      <!-- Quick replies or form will be inserted here -->
    </div>
  </div>
</div>

<script define:vars={{ businessType, companyName, phone, mapsUrl }}>
  const toggle = document.getElementById('chat-toggle');
  const chatWindow = document.getElementById('chat-window');
  const chatClose = document.getElementById('chat-close');
  const messagesContainer = document.getElementById('chat-messages');
  const inputArea = document.getElementById('chat-input-area');

  let currentStep = 'welcome';

  // Business-specific configurations
  const businessConfig = {
    'auto-parts': {
      welcome: `Guten Tag! Ich helfe Ihnen gerne bei ${companyName}. Wie kann ich Sie unterstÃ¼tzen?`,
      options: [
        { text: 'Ersatzteil suchen', value: 'search-part' },
        { text: 'Angebot anfragen', value: 'request-quote' },
        { text: 'Ã–ffnungszeiten', value: 'opening-hours' },
        { text: 'Anfahrt', value: 'directions' }
      ]
    },
    'bakery': {
      welcome: `Hallo! ğŸ‘‹ Willkommen bei ${companyName}. Wie kann ich Ihnen helfen?`,
      options: [
        { text: 'ğŸ° Torte bestellen', value: 'order-cake' },
        { text: 'ğŸ¥– Produktsortiment', value: 'products' },
        { text: 'ğŸ•’ Ã–ffnungszeiten', value: 'opening-hours' },
        { text: 'ğŸ“ Kontakt', value: 'contact' }
      ]
    },
    'lawyer': {
      welcome: `Guten Tag. Wie kann ich Ihnen bei ${companyName} weiterhelfen?`,
      options: [
        { text: 'Beratung anfragen', value: 'request-consultation' },
        { text: 'Fachgebiete', value: 'practice-areas' },
        { text: 'Termin vereinbaren', value: 'book-appointment' },
        { text: 'Kontakt', value: 'contact' }
      ]
    },
    'restaurant': {
      welcome: `Hallo! ğŸ‘‹ Willkommen bei ${companyName}. Wie kann ich Ihnen helfen?`,
      options: [
        { text: 'ğŸ½ï¸ Tisch reservieren', value: 'reserve-table' },
        { text: 'ğŸ“‹ Speisekarte', value: 'menu' },
        { text: 'ğŸ•’ Ã–ffnungszeiten', value: 'opening-hours' },
        { text: 'ğŸ“ Kontakt', value: 'contact' }
      ]
    },
    'default': {
      welcome: `Hallo! Wie kann ich Ihnen bei ${companyName} helfen?`,
      options: [
        { text: 'Angebot anfragen', value: 'request-quote' },
        { text: 'Ã–ffnungszeiten', value: 'opening-hours' },
        { text: 'Kontakt', value: 'contact' }
      ]
    }
  };

  const config = businessConfig[businessType] || businessConfig['default'];

  function addMessage(text, isBot = true) {
    const messageDiv = document.createElement('div');
    messageDiv.className = isBot
      ? 'bg-white p-3 rounded-lg shadow-sm border border-gray-200 max-w-[85%]'
      : 'bg-blue-600 text-white p-3 rounded-lg shadow-sm ml-auto max-w-[85%]';
    messageDiv.innerHTML = `<p class="text-sm">${text}</p>`;
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function showQuickReplies(options) {
    inputArea.innerHTML = '';
    const container = document.createElement('div');
    container.className = 'flex flex-col gap-2';

    options.forEach(option => {
      const button = document.createElement('button');
      button.className = 'bg-gray-100 hover:bg-blue-50 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium transition-colors border border-gray-300 hover:border-blue-600';
      button.textContent = option.text;
      button.onclick = () => handleOptionClick(option.value, option.text);
      container.appendChild(button);
    });

    inputArea.appendChild(container);
  }

  function showForm(type) {
    inputArea.innerHTML = '';
    const container = document.createElement('div');
    container.className = 'space-y-3';

    const form = document.createElement('form');
    form.className = 'space-y-3';
    form.onsubmit = (e) => {
      e.preventDefault();
      handleFormSubmit(type, new FormData(form));
    };

    if (type === 'auto-parts') {
      form.innerHTML = `
        <div>
          <label class="block text-xs font-medium mb-1">Ihr Name *</label>
          <input type="text" name="name" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent" />
        </div>
        <div>
          <label class="block text-xs font-medium mb-1">Ihr Fahrzeug *</label>
          <input type="text" name="vehicle" placeholder="z.B. VW Golf 7, 2015" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent" />
        </div>
        <div>
          <label class="block text-xs font-medium mb-1">Welches Ersatzteil? *</label>
          <textarea name="part" rows="2" placeholder="z.B. BremsbelÃ¤ge vorne" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent"></textarea>
        </div>
        <div>
          <label class="block text-xs font-medium mb-1">Telefon oder E-Mail *</label>
          <input type="text" name="contact" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent" />
        </div>
        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors text-sm">
          Anfrage senden
        </button>
      `;
    } else {
      form.innerHTML = `
        <div>
          <label class="block text-xs font-medium mb-1">Ihr Name *</label>
          <input type="text" name="name" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent" />
        </div>
        <div>
          <label class="block text-xs font-medium mb-1">E-Mail oder Telefon *</label>
          <input type="text" name="contact" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent" />
        </div>
        <div>
          <label class="block text-xs font-medium mb-1">Ihre Nachricht *</label>
          <textarea name="message" rows="3" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent"></textarea>
        </div>
        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors text-sm">
          Nachricht senden
        </button>
      `;
    }

    // Back button
    const backButton = document.createElement('button');
    backButton.type = 'button';
    backButton.className = 'w-full bg-gray-100 text-gray-700 py-2 rounded-lg font-medium hover:bg-gray-200 transition-colors text-sm border border-gray-300';
    backButton.textContent = 'ğŸ”™ ZurÃ¼ck zum MenÃ¼';
    backButton.onclick = () => handleOptionClick('back', 'ğŸ”™ ZurÃ¼ck zum MenÃ¼');

    container.appendChild(form);
    container.appendChild(backButton);
    inputArea.appendChild(container);
  }

  function handleOptionClick(value, text) {
    addMessage(text, false);

    setTimeout(() => {
      switch(value) {
        case 'search-part':
        case 'request-quote':
          addMessage('Perfekt! FÃ¼llen Sie bitte kurz das Formular aus und wir melden uns binnen 24 Stunden bei Ihnen. ğŸ“‹');
          setTimeout(() => showForm('auto-parts'), 500);
          break;

        case 'order-cake':
          addMessage('Gerne helfen wir Ihnen bei der Tortenbestellung! Bitte fÃ¼llen Sie das Formular aus. ğŸ°');
          setTimeout(() => showForm('default'), 500);
          break;

        case 'opening-hours':
          addMessage('Unsere Ã–ffnungszeiten:<br><br>ğŸ“… Montag - Freitag<br>ğŸ•’ 09:00 - 11:00 Uhr<br>ğŸ•’ 14:00 - 16:30 Uhr<br><br>Samstag & Sonntag: Geschlossen');
          setTimeout(() => {
            showQuickReplies([
              { text: 'ğŸ”™ ZurÃ¼ck zum MenÃ¼', value: 'back' },
              { text: phone ? `ğŸ“ Anrufen: ${phone}` : 'ğŸ“ Anrufen', value: 'call' }
            ]);
          }, 500);
          break;

        case 'directions':
          addMessage('Sie finden uns hier:<br><br>ğŸ“ Gutstrasse 158<br>8055 ZÃ¼rich<br><br>Gut erreichbar mit Ã–V und Auto. ParkplÃ¤tze vorhanden.');
          setTimeout(() => {
            showQuickReplies([
              { text: 'ğŸ”™ ZurÃ¼ck zum MenÃ¼', value: 'back' },
              { text: 'ğŸ—ºï¸ In Google Maps Ã¶ffnen', value: 'maps' }
            ]);
          }, 500);
          break;

        case 'contact':
        case 'products':
          addMessage('Gerne! Wie kann ich Ihnen weiterhelfen? FÃ¼llen Sie bitte das Kontaktformular aus.');
          setTimeout(() => showForm('default'), 500);
          break;

        case 'back':
          addMessage('Gerne! Womit kann ich Ihnen helfen?');
          setTimeout(() => showQuickReplies(config.options), 500);
          break;

        case 'call':
          if (phone) {
            window.location.href = `tel:${phone.replace(/\s/g, '')}`;
          }
          break;

        case 'maps':
          if (mapsUrl) {
            addMessage('Ã–ffne Google Maps...');
            setTimeout(() => {
              window.open(mapsUrl, '_blank');
            }, 500);
          } else {
            addMessage('Google Maps Link ist nicht verfÃ¼gbar.');
          }
          break;
      }
    }, 300);
  }

  function handleFormSubmit(type, formData) {
    const data = Object.fromEntries(formData);
    console.log('Form submitted:', data);

    addMessage('Vielen Dank fÃ¼r Ihre Anfrage! âœ…', false);
    setTimeout(() => {
      addMessage('Ihre Nachricht wurde erfolgreich Ã¼bermittelt. Wir melden uns in KÃ¼rze bei Ihnen!<br><br>In dringenden FÃ¤llen erreichen Sie uns auch telefonisch.' + (phone ? `<br><br>ğŸ“ ${phone}` : ''));
      inputArea.innerHTML = '<div class="text-center text-sm text-gray-500">Chat beendet</div>';
    }, 500);
  }

  function initChat() {
    messagesContainer.innerHTML = '';
    addMessage(config.welcome);
    setTimeout(() => showQuickReplies(config.options), 500);
  }

  toggle?.addEventListener('click', () => {
    const isHidden = chatWindow?.classList.contains('hidden');
    chatWindow?.classList.toggle('hidden');
    if (isHidden && messagesContainer.children.length === 0) {
      setTimeout(initChat, 200);
    }
  });

  chatClose?.addEventListener('click', () => {
    chatWindow?.classList.add('hidden');
  });

  // Auto-open chat on page load (only on desktop, not on mobile)
  const isMobile = window.innerWidth < 768;
  if (!isMobile) {
    setTimeout(() => {
      chatWindow?.classList.remove('hidden');
      initChat();
    }, 1000);
  }
</script>
