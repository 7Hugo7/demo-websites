---
// Interactive AI Chat Widget for Demo (with predefined responses)
interface Props {
  businessType?: 'auto-parts' | 'bakery' | 'lawyer' | 'restaurant' | 'industrial' | 'default';
  companyName?: string;
  phone?: string;
  mapsUrl?: string;
  primaryColor?: string;
}

const { businessType = 'default', companyName = 'Unser Team', phone, mapsUrl, primaryColor = '#2563eb' } = Astro.props;
---

<div id="ai-chat-widget" class="fixed bottom-4 right-4 md:bottom-6 md:right-6 z-50">
  <button
    id="chat-toggle"
    class="text-white p-3 md:p-4 rounded-full shadow-lg transition-all hover:scale-110"
    style={`background-color: ${primaryColor};`}
  >
    ğŸ’¬
  </button>

  <div
    id="chat-window"
    class="hidden fixed md:absolute bottom-0 left-0 right-0 md:bottom-16 md:right-0 md:left-auto w-full md:w-96 bg-white rounded-t-2xl md:rounded-2xl shadow-2xl flex flex-col h-[92vh] md:h-auto max-h-[92vh] md:max-h-[85vh] overflow-hidden"
  >
    <div class="text-white p-3 md:p-4 flex items-center justify-between flex-shrink-0" style={`background-color: ${primaryColor};`}>
      <h3 class="font-semibold text-base md:text-lg">Chat Assistent</h3>
      <button id="chat-close" class="text-white hover:text-gray-200 text-2xl md:text-xl p-1">âœ•</button>
    </div>

    <div id="chat-messages" class="flex-1 overflow-y-auto p-3 md:p-4 space-y-3 bg-gray-50 transition-all">
      <!-- Messages will be inserted here -->
    </div>

    <div id="chat-input-area" class="p-3 md:p-4 border-t border-gray-200 bg-white flex-shrink-0 overflow-y-auto transition-all">
      <!-- Quick replies or form will be inserted here -->
    </div>
  </div>
</div>

<script define:vars={{ businessType, companyName, phone, mapsUrl, primaryColor }}>
  const toggle = document.getElementById('chat-toggle');
  const chatWindow = document.getElementById('chat-window');
  const chatClose = document.getElementById('chat-close');
  const messagesContainer = document.getElementById('chat-messages');
  const inputArea = document.getElementById('chat-input-area');

  let currentStep = 'welcome';

  // Business-specific configurations
  const businessConfig = {
    'auto-parts': {
      welcome: `Guten Tag! Ich helfe Ihnen gerne bei ${companyName}. Wie kann ich Sie unterstÃ¼tzen?`,
      options: [
        { text: 'Ersatzteil suchen', value: 'search-part' },
        { text: 'Angebot anfragen', value: 'request-quote' },
        { text: 'Ã–ffnungszeiten', value: 'opening-hours' },
        { text: 'Anfahrt', value: 'directions' }
      ]
    },
    'bakery': {
      welcome: `Hallo! ğŸ‘‹ Willkommen bei ${companyName}. Wie kann ich Ihnen helfen?`,
      options: [
        { text: 'ğŸ° Torte bestellen', value: 'order-cake' },
        { text: 'ğŸ¥– Produktsortiment', value: 'products' },
        { text: 'ğŸ•’ Ã–ffnungszeiten', value: 'opening-hours' },
        { text: 'ğŸ“ Kontakt', value: 'contact' }
      ]
    },
    'lawyer': {
      welcome: `Guten Tag. Wie kann ich Ihnen bei ${companyName} weiterhelfen?`,
      options: [
        { text: 'Beratung anfragen', value: 'request-consultation' },
        { text: 'Fachgebiete', value: 'practice-areas' },
        { text: 'Termin vereinbaren', value: 'book-appointment' },
        { text: 'Kontakt', value: 'contact' }
      ]
    },
    'restaurant': {
      welcome: `Hallo! ğŸ‘‹ Willkommen bei ${companyName}. Wie kann ich Ihnen helfen?`,
      options: [
        { text: 'ğŸ½ï¸ Tisch reservieren', value: 'reserve-table' },
        { text: 'ğŸ“‹ Speisekarte', value: 'menu' },
        { text: 'ğŸ•’ Ã–ffnungszeiten', value: 'opening-hours' },
        { text: 'ğŸ“ Kontakt', value: 'contact' }
      ]
    },
    'industrial': {
      welcome: `Guten Tag! Wie kann ich Ihnen bei ${companyName} weiterhelfen?`,
      options: [
        { text: 'Beschichtung anfragen', value: 'request-quote' },
        { text: 'Verfahren & Leistungen', value: 'services' },
        { text: 'Ã–ffnungszeiten', value: 'opening-hours' },
        { text: 'Standort & Kontakt', value: 'contact' }
      ]
    },
    'default': {
      welcome: `Hallo! Wie kann ich Ihnen bei ${companyName} helfen?`,
      options: [
        { text: 'Angebot anfragen', value: 'request-quote' },
        { text: 'Ã–ffnungszeiten', value: 'opening-hours' },
        { text: 'Kontakt', value: 'contact' }
      ]
    }
  };

  const config = businessConfig[businessType] || businessConfig['default'];

  function addMessage(text, isBot = true) {
    const messageDiv = document.createElement('div');
    messageDiv.className = isBot
      ? 'bg-white p-3 rounded-lg shadow-sm border border-gray-200 max-w-[85%]'
      : 'text-white p-3 rounded-lg shadow-sm ml-auto max-w-[85%]';
    if (!isBot) {
      messageDiv.style.backgroundColor = primaryColor;
    }
    messageDiv.innerHTML = `<p class="text-sm">${text}</p>`;
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function showQuickReplies(options) {
    // Restore normal layout (show messages, reset input area size)
    messagesContainer.style.display = '';
    inputArea.style.flex = '';
    inputArea.style.maxHeight = '';

    inputArea.innerHTML = '';
    const container = document.createElement('div');
    container.className = 'flex flex-col gap-2';

    options.forEach(option => {
      const button = document.createElement('button');
      button.className = 'bg-gray-100 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium transition-colors border border-gray-300';
      button.textContent = option.text;
      button.onclick = () => handleOptionClick(option.value, option.text);
      button.onmouseover = () => {
        button.style.backgroundColor = primaryColor + '10';
        button.style.borderColor = primaryColor;
      };
      button.onmouseout = () => {
        button.style.backgroundColor = '#f3f4f6';
        button.style.borderColor = '#d1d5db';
      };
      container.appendChild(button);
    });

    inputArea.appendChild(container);
  }

  function showForm(type) {
    // Hide messages and expand input area to fill entire chat
    messagesContainer.style.display = 'none';
    inputArea.style.flex = '1';
    inputArea.style.maxHeight = 'none';

    inputArea.innerHTML = '';
    const container = document.createElement('div');
    container.className = 'space-y-2 md:space-y-3 h-full flex flex-col justify-center';

    const form = document.createElement('form');
    form.className = 'space-y-2 md:space-y-3';
    form.onsubmit = (e) => {
      e.preventDefault();
      handleFormSubmit(type, new FormData(form));
    };

    if (type === 'auto-parts') {
      form.innerHTML = `
        <div>
          <label class="block text-sm font-medium mb-1">Ihr Name *</label>
          <input type="text" name="name" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:border-transparent" style="outline: none;" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Ihr Fahrzeug *</label>
          <input type="text" name="vehicle" placeholder="z.B. VW Golf 7, 2015" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:border-transparent" style="outline: none;" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Welches Ersatzteil? *</label>
          <textarea name="part" rows="2" placeholder="z.B. BremsbelÃ¤ge vorne" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:border-transparent" style="outline: none;"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Telefon oder E-Mail *</label>
          <input type="text" name="contact" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:border-transparent" style="outline: none;" />
        </div>
        <button type="submit" class="w-full text-white py-2 rounded-lg font-semibold transition-colors text-sm md:text-base" style="background-color: ${primaryColor};">
          Anfrage senden
        </button>
      `;
    } else if (type === 'industrial') {
      form.innerHTML = `
        <div>
          <label class="block text-sm font-medium mb-1">Ihr Name *</label>
          <input type="text" name="name" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:border-transparent" style="outline: none;" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Firma</label>
          <input type="text" name="company" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:border-transparent" style="outline: none;" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Bauteil/Material *</label>
          <input type="text" name="component" placeholder="z.B. Stahlwelle, Zylinder" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:border-transparent" style="outline: none;" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">GewÃ¼nschte Beschichtung *</label>
          <textarea name="coating" rows="2" placeholder="z.B. HVOF, Plasma, Korrosionsschutz" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:border-transparent" style="outline: none;"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Telefon oder E-Mail *</label>
          <input type="text" name="contact" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:border-transparent" style="outline: none;" />
        </div>
        <button type="submit" class="w-full text-white py-2 rounded-lg font-semibold transition-colors text-sm md:text-base" style="background-color: ${primaryColor};">
          Anfrage senden
        </button>
      `;
    } else {
      form.innerHTML = `
        <div>
          <label class="block text-sm font-medium mb-1">Ihr Name *</label>
          <input type="text" name="name" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:border-transparent" style="outline: none;" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">E-Mail oder Telefon *</label>
          <input type="text" name="contact" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:border-transparent" style="outline: none;" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Ihre Nachricht *</label>
          <textarea name="message" rows="2" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:border-transparent" style="outline: none;"></textarea>
        </div>
        <button type="submit" class="w-full text-white py-2 rounded-lg font-semibold transition-colors text-sm md:text-base" style="background-color: ${primaryColor};">
          Nachricht senden
        </button>
      `;
    }

    // Back button
    const backButton = document.createElement('button');
    backButton.type = 'button';
    backButton.className = 'w-full bg-gray-100 text-gray-700 py-2 rounded-lg font-medium hover:bg-gray-200 transition-colors text-sm border border-gray-300';
    backButton.textContent = 'ğŸ”™ ZurÃ¼ck zum MenÃ¼';
    backButton.onclick = () => handleOptionClick('back', 'ğŸ”™ ZurÃ¼ck zum MenÃ¼');

    container.appendChild(form);
    container.appendChild(backButton);
    inputArea.appendChild(container);
  }

  function handleOptionClick(value, text) {
    addMessage(text, false);

    setTimeout(() => {
      switch(value) {
        case 'search-part':
          addMessage('Perfekt! FÃ¼llen Sie bitte kurz das Formular aus und wir melden uns binnen 24 Stunden bei Ihnen. ğŸ“‹');
          setTimeout(() => showForm('auto-parts'), 500);
          break;

        case 'request-quote':
          addMessage('Perfekt! FÃ¼llen Sie bitte kurz das Formular aus und wir melden uns binnen 24 Stunden bei Ihnen. ğŸ“‹');
          const formType = businessType === 'industrial' ? 'industrial' : (businessType === 'auto-parts' ? 'auto-parts' : 'default');
          setTimeout(() => showForm(formType), 500);
          break;

        case 'order-cake':
          addMessage('Gerne helfen wir Ihnen bei der Tortenbestellung! Bitte fÃ¼llen Sie das Formular aus. ğŸ°');
          setTimeout(() => showForm('default'), 500);
          break;

        case 'opening-hours':
          if (businessType === 'industrial') {
            addMessage('Unsere Ã–ffnungszeiten:<br><br>Montag - Donnerstag<br>07:00 - 12:00 Uhr<br>13:30 - 17:00 Uhr<br><br>Freitag<br>07:00 - 12:00 Uhr<br>13:30 - 16:00 Uhr<br><br>Samstag & Sonntag: Geschlossen');
            setTimeout(() => {
              showQuickReplies([
                { text: 'ZurÃ¼ck zum MenÃ¼', value: 'back' },
                { text: phone ? `Anrufen: ${phone}` : 'Anrufen', value: 'call' }
              ]);
            }, 500);
          } else {
            addMessage('Unsere Ã–ffnungszeiten:<br><br>ğŸ“… Montag - Donnerstag<br>ğŸ•’ 07:00 - 12:00 Uhr<br>ğŸ•’ 13:30 - 17:00 Uhr<br><br>ğŸ“… Freitag<br>ğŸ•’ 07:00 - 12:00 Uhr<br>ğŸ•’ 13:30 - 16:00 Uhr<br><br>Samstag & Sonntag: Geschlossen');
            setTimeout(() => {
              showQuickReplies([
                { text: 'ğŸ”™ ZurÃ¼ck zum MenÃ¼', value: 'back' },
                { text: phone ? `ğŸ“ Anrufen: ${phone}` : 'ğŸ“ Anrufen', value: 'call' }
              ]);
            }, 500);
          }
          break;

        case 'directions':
          addMessage('Sie finden uns hier:<br><br>ğŸ“ Gutstrasse 158<br>8055 ZÃ¼rich<br><br>Gut erreichbar mit Ã–V und Auto. ParkplÃ¤tze vorhanden.');
          setTimeout(() => {
            showQuickReplies([
              { text: 'ğŸ”™ ZurÃ¼ck zum MenÃ¼', value: 'back' },
              { text: 'ğŸ—ºï¸ In Google Maps Ã¶ffnen', value: 'maps' }
            ]);
          }, 500);
          break;

        case 'contact':
        case 'products':
          addMessage('Gerne! Wie kann ich Ihnen weiterhelfen? FÃ¼llen Sie bitte das Kontaktformular aus.');
          setTimeout(() => showForm('default'), 500);
          break;

        case 'services':
          addMessage('Wir bieten professionelle OberflÃ¤chentechnik:<br><br>â€¢ Thermisches Spritzen (HVOF, Plasma, Lichtbogen)<br>â€¢ Metallspritzen & Verschleissschutz<br>â€¢ Korrosionsschutz<br>â€¢ Sandstrahlen & OberflÃ¤chenvorbereitung<br><br>Gerne beraten wir Sie zu Ihrem Projekt!');
          setTimeout(() => {
            showQuickReplies([
              { text: 'ZurÃ¼ck zum MenÃ¼', value: 'back' },
              { text: 'Angebot anfragen', value: 'request-quote' }
            ]);
          }, 500);
          break;

        case 'back':
          addMessage('Gerne! Womit kann ich Ihnen helfen?');
          setTimeout(() => showQuickReplies(config.options), 500);
          break;

        case 'call':
          if (phone) {
            window.location.href = `tel:${phone.replace(/\s/g, '')}`;
          }
          break;

        case 'maps':
          if (mapsUrl) {
            addMessage('Ã–ffne Google Maps...');
            setTimeout(() => {
              window.open(mapsUrl, '_blank');
            }, 500);
          } else {
            addMessage('Google Maps Link ist nicht verfÃ¼gbar.');
          }
          break;
      }
    }, 300);
  }

  function handleFormSubmit(type, formData) {
    const data = Object.fromEntries(formData);
    console.log('Form submitted:', data);

    addMessage('Vielen Dank fÃ¼r Ihre Anfrage! âœ…', false);
    setTimeout(() => {
      addMessage('Ihre Nachricht wurde erfolgreich Ã¼bermittelt. Wir melden uns in KÃ¼rze bei Ihnen!<br><br>In dringenden FÃ¤llen erreichen Sie uns auch telefonisch.' + (phone ? `<br><br>ğŸ“ ${phone}` : ''));
      inputArea.innerHTML = '<div class="text-center text-sm text-gray-500">Chat beendet</div>';
    }, 500);
  }

  function initChat() {
    messagesContainer.innerHTML = '';
    addMessage(config.welcome);
    setTimeout(() => showQuickReplies(config.options), 500);
  }

  toggle?.addEventListener('click', () => {
    const isHidden = chatWindow?.classList.contains('hidden');
    chatWindow?.classList.toggle('hidden');
    if (isHidden && messagesContainer.children.length === 0) {
      setTimeout(initChat, 200);
    }
  });

  chatClose?.addEventListener('click', () => {
    chatWindow?.classList.add('hidden');
  });

  // Auto-open chat on page load (only on desktop, not on mobile)
  const checkAndAutoOpen = () => {
    const isMobile = window.matchMedia('(max-width: 767px)').matches;
    if (!isMobile) {
      chatWindow?.classList.remove('hidden');
      initChat();
    }
  };

  // Wait for page to be fully loaded before checking
  if (document.readyState === 'complete') {
    setTimeout(checkAndAutoOpen, 1000);
  } else {
    window.addEventListener('load', () => {
      setTimeout(checkAndAutoOpen, 1000);
    });
  }
</script>
